<% extends ./base.html %>
<% subskin extrahead %>
    <!-- OpenLayers resources -->
    <link rel="stylesheet" type="text/css" href="externals/openlayers/theme/default/style.css">
    <script type="text/javascript" src="script/OpenLayers.js"></script>

    <!-- GeoExt resources -->
    <link rel="stylesheet" type="text/css" href="externals/GeoExt/resources/css/popup.css">
    <link rel="stylesheet" type="text/css" href="externals/GeoExt/resources/css/layerlegend.css">
    <link rel="stylesheet" type="text/css" href="externals/GeoExt/resources/css/gxtheme-gray.css">
    <script type="text/javascript" src="script/GeoExt.js"></script> 

    <!-- gxp resources -->
    <link rel="stylesheet" type="text/css" href="externals/gxp/src/theme/all.css">
    <script type="text/javascript" src="script/gxp.js"></script> 

    <!--script type="text/javascript" src="script/proj4js.js"></script-->

    <!-- GeoExplorer resources -->
    <link rel="stylesheet" type="text/css" href="theme/app/geoexplorer.css" />
    <link rel="stylesheet" type="text/css" href="theme/app/fdh.css" />
    <!--[if IE]><link rel="stylesheet" type="text/css" href="theme/app/ie.css"/><![endif]-->        

    <script type="text/javascript" src="script/GeoExplorer.js"></script>
    <script type="text/javascript" src="script/ux.js"></script>
    
    <!-- PrintPreview resources 
    <link rel="stylesheet" type="text/css" href="externals/PrintPreview/resources/css/printpreview.css">
    <script type="text/javascript" src="script/PrintPreview.js"></script>-->
    
    <!-- csw resources -->
    <link rel="stylesheet" type="text/css" href="externals/csw/CSWViewer/css/csw.css">
    <script type="text/javascript" src="auth/base64.js"></script>
    <script type="text/javascript" src="script/CSWViewer.js"></script>
    
    <!-- geocoding data  -->
    <script type="text/javascript" src="data/georeferences.js"></script>
    
	<!-- translation data  -->
    <script type="text/javascript" src="translations/en.js"></script>
    <script type="text/javascript" src="translations/fr.js"></script>
    <script type="text/javascript" src="translations/it.js"></script>
    
    <script>
        
        var app;        
        var modified = false; var mapIdentifier; var authorization; var fullScreen;

		// //////////////////////////////////////////////////
		// Parsing the request to get the parameters
		// //////////////////////////////////////////////////
        var params = location.search.replace(/^\?/,'').replace(/&amp;/g,'&').split("&");
        for (var j=0; j < params.length; j++) {
			var param = params[j].split("=");
			if(param[0]){
				switch ( param[0] ) {
					case "mapId": 
									try{
										mapIdentifier = parseInt(param[1]);
									}catch(e){
										mapIdentifier = -1;
									} 
									break;
					case "auth" : 
									if(param[1] == 'true') 
										authorization = true; 
									else 
										authorization = false; 
									break;
					case "fullScreen" : 
									if(param[1] == 'true') 
										fullScreen = true; 
									else 
										fullScreen = false; 
									break;
					default :       
									mapIdentifier = -1;
									authorization = false;
									fullScreen = false; 
				}
			}
        }
		
		// ///////////////////////////////////////////////////////////////
		// Custom variables from the urlConfig user configuration file 
		// ///////////////////////////////////////////////////////////////
        var proxy; 
        var geoStoreBaseURL;        
        var customSources;
		
        var onReady = function(){

            Ext.BLANK_IMAGE_URL = (function() {
                    if (Ext.isIE8 || Ext.isGecko || Ext.isOpera || Ext.isChrome) {
                        return "data:image/gif;base64,R0lGODlhAQABAID/AMDAwAAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==";
                    } else {
                        return "theme/app/img/blank.gif";
                    }
            })();

            OpenLayers.ImgPath = "externals/openlayers/theme/default/img/";
            //Proj4js.defs["EPSG:102113"]="+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +no_defs";

            gxp.plugins.ZoomToExtent.prototype.closest = false;

            Ext.ux.IFrameComponent = Ext.extend(Ext.BoxComponent, {
                 onRender : function(ct, position){
                      this.el = ct.createChild({
                        tag: 'iframe',
                        id: 'iframe-'+ this.id,
                        frameBorder: 0, 
                        src: this.url
                      });
                 }
            });
            
			// //////////////////////////////////////////////////////            
            // Setting the locale based on query string parameter
            // //////////////////////////////////////////////////////
			var query = location.search;        
            if(query && query.substr(0,1) === "?"){
                query = query.substring(1);
            }
            
            var url = Ext.urlDecode(query);        
            var code = url.locale || 'en';			
            var langData = [['en', 'English'],['fr','Français'],['it','Italiano']];
            
            // //////////////////////////////////////////////////        
            // Setting the initial language for the selector
            // //////////////////////////////////////////////////
			var initialLanguageString;					
			Ext.each(langData, function(rec){
				if(rec[0] === code.toLowerCase()){
					initialLanguageString = rec[1];
					return;
				}
			});
			
			initialLanguageString = !initialLanguageString ? "English" : initialLanguageString;	
			
			// ////////////////////////////////////////////////////
			// Setting the language code for the GeoExt tools
			// ////////////////////////////////////////////////////
			if (GeoExt.Lang) {
                GeoExt.Lang.set(code);
            }
            
            var languageSelector = new Ext.form.ComboBox({
                store: new Ext.data.ArrayStore({
                    fields: ['code', 'name'],
                    data :  langData
                }),
                displayField: 'name',
                typeAhead: true,
                mode: 'local',
                forceSelection: true,
                triggerAction: 'all',
                emptyText: initialLanguageString,
                selectOnFocus:false,
                editable: false,
                width: 100,
                listeners: {
                    beforeselect: function(cb, record, index){
					   var c = record.get('code');
                       if(c && c == code)
                          return false; 
					   else
						  languageSelector.prevLang = code;
                    },                    
                    select: function(cb, record, index) {         
                        
                        var switchLang = function(buttonId, text, opt){
                            if(buttonId === 'ok'){
                                var c = record.get('code');
								var u = location.pathname + '?locale=' + c;
								
								if(url.auth){
									u += '&auth=' + url.auth;
									if(url.auth == 'false')
										u += '&fullScreen=true';
								}
								
								if(url.mapId)
									u += '&mapId=' + url.mapId;
								
								location.replace(u);                                
                            }else{																
                                if(languageSelector.prevLang && languageSelector.prevLang == 'fr'){
                                    cb.setValue('Français');
                                }else if(languageSelector.prevLang && languageSelector.prevLang == 'it'){
									cb.setValue('Italiano');
								}else{
                                    cb.setValue('English');
                                }
                            }
                        };
                        
                        var switchLangActionTip = "Switch Language";
                        var switchLangConfirmationText = "You are sure to change language? All current settings and selections will be lost";
                        
                        if(code === 'fr'){
                            switchLangActionTip = "Changement de langue";
                            switchLangConfirmationText = "Vous êtes certain que vous souhaitez modifier la langue ? Tous les paramètres et les sélections actuels seront perdues.";
                        }else if(code === 'it'){
                            switchLangActionTip = "Cambiamento Lingua";
                            switchLangConfirmationText = "Si è sicuri di voler cambiare lingua? Le selezioni e le impostazioni correnti saranno persi.";
                        }
                        
                        Ext.Msg.show({
                           title: switchLangActionTip,
                           msg: switchLangConfirmationText,
                           buttons: Ext.Msg.OKCANCEL,
                           fn: switchLang,
                           icon: Ext.MessageBox.QUESTION
                        });  
                    }
                }
            });
			
            var appTabs = new Ext.TabPanel({
                region: 'center',
                border : false,
                id : 'appTabs',
                enableTabScroll: true
            });         

            var aboutButton = new Ext.Button({
                text: GeoExplorer.prototype.appInfoText,
                iconCls: "icon-geoexplorer",
                handler: function(){
                    var appInfo = new Ext.Panel({
                        header: false,
                        html: "<iframe style='border: none; height: 100%; width: 100%' src='about.html' frameborder='0' border='0'><a target='_blank' href='about.html'>"+ GeoExplorer.prototype.aboutText+"</a> </iframe>"
                    });

                    var win = new Ext.Window({
                        title:  GeoExplorer.prototype.aboutThisMapText,
                        modal: true,
                        layout: "fit",
                        width: 340,
                        height: 260,
                        items: [appInfo]
                    });
                    
                    win.show();
                }
            });
            
            var poweredByGeoSol = new Ext.Button({
                tooltip: 'Powered by GeoSolutions',
                iconCls: "icon-geosol",
                width : 150,
                handler: function(btn){
                    window.open('http://geo-solutions.it/contact/', '_blank');
                }
            });    
			var headerContent = [
					'<div id="header" style="background-image: url(theme/app/img/bgimg.jpg);background-repeat-x:repeat">',
					'<img src="theme/app/img/eurogeos/banner.png"  border="0" />' ,
					'<img src="theme/app/img/eurogeos/fao.png" usemap="#IM_right-banner"  height="86" border="0" style="float:right;margin-right:20px"/> ',
					//'</div>',
					//'<map name="IM_left-banner">',
					//'<area shape="rect" coords="0,6,72,75" href="http://www.fouta-djallon-programme.org/index.php?lang=en" alt="Fouta Djallon HighLands Integrated Natural Resources Management Project" title="Fouta Djallon HighLands Integrated Natural Resources Management Project"    />',
					//'</map>',
					//'<map name="IM_right-banner">',
					//'<area shape="rect" coords="183,3,240,78" href="http://www.unep.org/" alt="United Nations Environment Programme" title="United Nations Environment Programme"    />',
					//'<area shape="rect" coords="246,4,303,79" href="http://www.gefweb.org/" alt="Global Environment Facility" title="Global Environment Facility"    />',
					//'<area shape="rect" coords="306,6,373,79" href="http://www.fao.org/" alt="Food and Agriculture Organization of the United Nations" title="Food and Agriculture Organization of the United Nations"    />',
					//'</map>',
					'</div>'
				];
            var appViewport = new Ext.Viewport({
                id: 'appVieport',
                layout:'fit',
                border:false,
                items: [
					{
                    region : 'center',
                    layout : 'border',
                    border : false,
                    header : false,                    
                    items : [{
							border: false,
							header: false,
							html:  headerContent,
							region: 'north',
							collapsible: true,
							collapseMode:  'mini',
							hideCollapseTool: true,
							split: true,
							animCollapse : false,
							minHeight: 86,
							maxHeight: 86,
							height: 86,
							id : 'euroGeosHeader'
						},appTabs],                            
                    bbar : [
                      poweredByGeoSol, ' ', aboutButton, '->',languageSelector
                    ]
                }]
            });
            
            // /////////////////////////////////////////////////////////////
            // Parsing WMS servers Sources for getCapabilities operation
            // /////////////////////////////////////////////////////////////
            var sources = "{" + 
                "\"eurogeos\": {" +
                   // "\"ptype\": \"gxp_wmssource\"," +
                    "\"title\": \"EuroGeos GeoServer\"," +
                    //"\"projection\":\"EPSG:900913\"," +
                    "\"url\": \"http://foreststats.org/geoserver/ows\"" +
                "}," +
                "\"mapquest\": {" +
                    "\"ptype\": \"gxp_mapquestsource\"" +
                "}," + 
                "\"osm\": {" + 
                    "\"ptype\": \"gxp_osmsource\"" +
                "}," +
                "\"google\": {" +
                    "\"ptype\": \"gxp_googlesource\"" + 
                "}," +
                "\"bing\": {" +
                    "\"ptype\": \"gxp_bingsource\"" + 
                "}," + 
                "\"ol\": {" + 
                    "\"ptype\": \"gxp_olsource\"" + 
                "}";
            
            if(customSources.length > 0)
                sources += ",";
                
            for(var s=0; s<customSources.length; s++){ 
                var src = Ext.util.JSON.encode(customSources[s]);
                sources += "\"source" + s + "\":" + src;
                 
                if(s + 1 < customSources.length)
                    sources += ",";
            }
             
            sources +="}";

            try{
                sources = Ext.util.JSON.decode(sources);
            }catch(e){
                sources = {
                    mapquest: {
                        ptype: "gxp_mapquestsource"
                    },
                    osm: {
                        ptype: "gxp_osmsource"
                    },
                    google: {
                        ptype: "gxp_googlesource"
                    },
                    bing: {
                        ptype: "gxp_bingsource"
                    },
                    ol: {
                        ptype: "gxp_olsource"
                    }
                };
          
                Ext.Msg.show({
                      title: "Startup",
                      msg: "An error occurred while parsing the CUSTOM GeoServer sources",
                      buttons: Ext.Msg.OK,
                      icon: Ext.MessageBox.ERROR
                });
            }
			      		     
			/*var auth = 'Basic ' + Base64.encode('admin:admin');
			      Ext.Ajax.defaultHeaders = {
                'Authorization' : auth
            };*/
             			
            app = new GeoExplorer.Composer({
                modified: false,
                proxy: proxy,
                xmlJsonTranslateService: "http://demo1.geo-solutions.it/xmlJsonTranslate/",
                defaultSourceType: "gxp_wmssource",
                renderToTab : 'appTabs',
                //printService:"http://localhost:8080/geoserver/pdf/",
                //mapTitle: (code === 'en' ? 'View' : (code === 'fr' ? 'Veu' : 'Vista')),
                about: {
                    title: "Custom Map",
                    'abstract': "Custom Map",
                    contact: "<a href='#'>#</a>."
                },
                sources: sources,
                georeferences: georeferences_data,
            
                map: {
					projection: "EPSG:4326",
                    units: "degrees",
                    maxExtent: [
                        -180,-90,
                        180, 90
                    ],
                    layers: [{
                        source: "eurogeos",
                        title: "World Blue Marble small",
                        name: "gn:world",
                        group: "background"
                    },{
                        source: "eurogeos",
                        title: "Fra EuroGeos Data",
						format: "image/gif",
                        name: "fra:fra1",
						visibility: false,
						display: false,
						transparent: true,
                        group: "hidden",
						displayInLayerSwitcher:false
                    },{
                        source: "eurogeos",
                        title: "Boundaries",
                        name: "gn:gboundaries",
						transparent: true
                    }],
                    center: [0, 0],
                    zoom: 3
					
                }
            }, mapIdentifier, authorization, fullScreen);   
            
            app.on({
                'portalready' : function(){
                    if(fullScreen){
                        var ovestPanel = Ext.getCmp('west');
                        ovestPanel.setDisabled();
                        ovestPanel.hide();
                        ovestPanel.collapse();
						Ext.getCmp('euroGeosHeader').collapse();
                    }
                }, 
                'ready' : function(){
                    app.modified = false;
                }
            });
	    };			
			
	    Ext.Ajax.request({
			  //url: "/MapStore/urlConfig.js",
			  url: "/urlConfig.js",
			  method: 'GET',
			  success: function(response, opts){      
				  var serverConfig;    
				  
				  try{
					  serverConfig = Ext.util.JSON.decode(response.responseText);
				  }catch(e){
					  Ext.Msg.show({
							title: "Startup",
							msg: "An error occurred while parsing the GeoStore URL config: " + response.status,
							buttons: Ext.Msg.OK,
							icon: Ext.MessageBox.ERROR
					  });
				  }
				  
				  if(serverConfig){
					  proxy = serverConfig.proxy; 
					  geoStoreBaseURL = serverConfig.geoStoreBase;                  
					  customSources = serverConfig.gsSources;

					  // ///////////////////////////////////////////////  
					  // Run the application when browser is ready
					  // ///////////////////////////////////////////////
					  Ext.onReady(onReady);
				  }
			  },
			  failure:  function(response, opts){
				  Ext.Msg.show({
						title: "Startup",
						msg: "An error occurred while getting the GeoStore URL config: " + response.status,
						buttons: Ext.Msg.OK,
						icon: Ext.MessageBox.ERROR
				  });
		      }
	    });
        
    </script>