<% extends ./base.html %>
<% subskin extrahead %>
    <!-- OpenLayers resources -->
    <link rel="stylesheet" type="text/css" href="externals/openlayers/theme/default/style.css">
    <script type="text/javascript" src="script/OpenLayers.js"></script>
	
    <!-- GeoExt resources -->
    <link rel="stylesheet" type="text/css" href="externals/GeoExt/resources/css/popup.css">
    <link rel="stylesheet" type="text/css" href="externals/GeoExt/resources/css/layerlegend.css">
    <link rel="stylesheet" type="text/css" href="externals/GeoExt/resources/css/gxtheme-gray.css">
    <script type="text/javascript" src="script/GeoExt.js"></script> 

    <!-- gxp resources -->
    <link rel="stylesheet" type="text/css" href="externals/gxp/src/theme/all.css">
    <link rel="stylesheet" type="text/css" href="externals/gxp/src/theme/gxpmapstore.css">
    <script type="text/javascript" src="script/gxp.js"></script> 

    <!-- proj4js resources 
    <script type="text/javascript" src="script/proj4js.js"></script>-->

    <!-- GeoExplorer resources -->
    <link rel="stylesheet" type="text/css" href="theme/app/geoexplorer.css" />
    <link rel="stylesheet" type="text/css" href="theme/app/mapstore.css" />
    <!--[if IE]><link rel="stylesheet" type="text/css" href="theme/app/ie.css"/><![endif]-->        

    <script type="text/javascript" src="script/GeoExplorer.js"></script>
    <script type="text/javascript" src="script/ux.js"></script>
    
    <!-- PrintPreview resources -->
    <link rel="stylesheet" type="text/css" href="externals/PrintPreview/resources/css/printpreview.css">
    <script type="text/javascript" src="script/PrintPreview.js"></script>
    
    <!-- csw resources -->
    <link rel="stylesheet" type="text/css" href="externals/csw/CSWViewer/css/csw.css">
    <script type="text/javascript" src="auth/base64.js"></script>
    <script type="text/javascript" src="script/CSWViewer.js"></script>
    
    <!-- translation data  -->
    <script type="text/javascript" src="translations/en.js"></script>
    <script type="text/javascript" src="translations/fr.js"></script>
    <script type="text/javascript" src="translations/it.js"></script>
    
    <script>
        
        var app;
        
        var modified = false; var mapIdentifier; var authorization; var fullScreen;

        //
        // Parsing the request to get the parameters
        //
        var params = location.search.replace(/^\?/,'').replace(/&amp;/g,'&').split("&");
        
        for (var j=0; j < params.length; j++) {
          var param = params[j].split("=");
          switch ( param[0] ) {
            case "mapId"	: 
                            try{
                                mapIdentifier = parseInt(param[1]);
                            }catch(e){
                                mapIdentifier = -1;
                            } 
                            break;
            case "auth" : 
                            if(param[1] == 'true') 
                                authorization = true; 
                            else 
                                authorization = false; 
                            break;
            case "fullScreen" : 
                            if(param[1] == 'true') 
                                fullScreen = true; 
                            else 
                                fullScreen = false; 
                            break;
            default : 
                            mapIdentifier = -1;
                            authorization = false;
                            fullScreen = false; 
          }
        }
		            
        var proxy; 
        var geoStoreBaseURL;        
        var customSources;
        
        var onReady = function(){

            Ext.BLANK_IMAGE_URL = (function() {
                    if (Ext.isIE8 || Ext.isGecko || Ext.isOpera || Ext.isChrome) {
                        return "data:image/gif;base64,R0lGODlhAQABAID/AMDAwAAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==";
                    } else {
                        return "theme/app/img/blank.gif";
                    }
            })();

            OpenLayers.ImgPath = "externals/openlayers/theme/default/img/";

            gxp.plugins.ZoomToExtent.prototype.closest = false;
                                    
            Ext.ux.IFrameComponent = Ext.extend(Ext.BoxComponent, {
                 onRender : function(ct, position){
                      this.el = ct.createChild({
                        tag: 'iframe',
                        id: 'iframe-'+ this.id,
                        frameBorder: 0, 
                        src: this.url
                      });
                 }
            });
            
            //            
            // optionally set locale based on query string parameter
            //
            var curLang = OpenLayers.Util.getParameters()["locale"] || 'en';            
            var langData = [['en', 'English'],['fr','Français'],['it','Italiano']];
            
            var query = location.search;        
            if(query && query.substr(0,1) === "?"){
                query = query.substring(1);
            }
            
            var url = Ext.urlDecode(query);        
            var code = url.locale;   

            if(!code){
                code = "en";
            }
            
            var initialLanguageString;
            
            //        
            //check if code is valid
            //
            if(code){
                Ext.each(langData, function(rec){
                    if(rec[0] === code.toLowerCase()){
                        initialLanguageString = rec[1];
                        return;
                    }
                });
            }            
			
			      if (GeoExt.Lang) {
                GeoExt.Lang.set(code);
            }
			
            if(!initialLanguageString){
                initialLanguageString = "English";
            }
            
            var languageSelector = new Ext.form.ComboBox({
                store: new Ext.data.ArrayStore({
                    fields: ['code', 'name'],
                    data :  langData
                }),
                displayField: 'name',
                typeAhead: true,
                mode: 'local',
                forceSelection: true,
                triggerAction: 'all',
                emptyText: initialLanguageString,
                selectOnFocus:false,
                editable: false,
                width: 100,
                listeners: {
                    beforeselect: function(cb, record, index){
                       if(curLang == record.get('code'))
                          return false; 
                    },                    
                    select: function(cb, record, index) {         
                        
                       var switchLang = function(buttonId, text, opt){
                            if(buttonId === 'ok'){
                                var code = record.get('code');
                                if(code){
                                    location.replace(
                                        location.pathname + '?locale=' + code);
                                }  
                            }else{
                                var code = record.get('code');
                                if(code == 'fr'){
                                    cb.setValue('English');
                                }else{
                                    cb.setValue('Français');
                                }
                            }
                        };
                        
                        var switchLangActionTip = "Switch Language";
                        var switchLangConfirmationText = "You are sure to change language? All unsaved data will be lost";
                        
                        if(curLang === 'fr'){
                            switchLangActionTip = "Changement de langue";
                            switchLangConfirmationText = "Vous êtes certain que vous souhaitez modifier la langue ? toutes les données non enregistrées seront a perdu";
                        }else if(curLang === 'it'){
                            switchLangActionTip = "Cambiamento Lingua";
                            switchLangConfirmationText = "Si è sicuri di voler cambiare lingua? I dati non salvati saranno persi";
                        }
                        
                        Ext.Msg.show({
                           title: switchLangActionTip,
                           msg: switchLangConfirmationText,
                           buttons: Ext.Msg.OKCANCEL,
                           fn: switchLang,
                           icon: Ext.MessageBox.QUESTION
                        });  
                    }
                }
            });
            
            var appTabs = new Ext.TabPanel({
                region: 'center',
                border : false,
                id : 'appTabs',
                enableTabScroll: true
            });         

            var aboutButton = new Ext.Button({
                text: GeoExplorer.prototype.appInfoText,
                iconCls: "icon-geoexplorer",
                handler: function(){
                    var appInfo = new Ext.Panel({
                        header: false,
                        html: "<iframe style='border: none; height: 100%; width: 100%' src='about.html' frameborder='0' border='0'><a target='_blank' href='about.html'>"+ GeoExplorer.prototype.aboutText+"</a> </iframe>"
                    });

                    var win = new Ext.Window({
                        title:  GeoExplorer.prototype.aboutThisMapText,
                        modal: true,
                        layout: "fit",
                        width: 300,
                        height: 300,
                        items: [appInfo]
                    });
                    
                    win.show();
                }
            });
            
            var poweredByGeoSol = new Ext.Button({
                tooltip: 'Powered by GeoSolutions',
                iconCls: "icon-geosol",
                width : 150,
                handler: function(btn){
                    window.open('http://geo-solutions.it/contact/', '_blank');
                }
            });    
			
            var headerContent = [
              '<table class="banner">',
              '<td>',
              '<img src="theme/app/img/logos/nurc_logo_3.jpg"/>',
              '</td>',
              '<td class="header">',
              '<h1>NURC</h1>',
              '<p>Integrated Decision Aid</p>',
              '</td>',
              '<td align="right">',
              '<img src="theme/app/img/logos/banner4.gif"/>',
              '</td>',
              '</table>'
            ];
	    
            var appViewport = new Ext.Viewport({
                id: 'appVieport',
                layout:'fit',
                border:false,
                items: [{
                    region : 'center',
                    layout : 'border',
                    border : false,
                    header : false,                                     
                    items : [{
                      border: false,
                      header: false,
                      html:  headerContent,
                      region: 'north',
                      collapsible: true,
                      collapseMode:  'mini',
                      hideCollapseTool: true,
                      split: true,
                      animCollapse : false,
                      minHeight: 90,
                      maxHeight: 90,
                      height: 90,
                      id : 'fdhHeader'
                    },appTabs],                            
                    bbar : [
                      poweredByGeoSol, ' ', aboutButton, '->',languageSelector
                    ]
                }]
            });

            //
            // Parsing WMS servers Sources for getCapabilities operation
            //
            var sources = "{" + 
                "\"ida\": {" + 
                    "\"url\":\"http://192.168.1.8:8080/geoserver/ows\"," +
                    "\"title\":\"IDA GeoServer\"," +
                    "\"version\":\"1.1.1\"" +
                "}," +
                "\"playground\": {" + 
                    "\"url\":\"http://demo1.geo-solutions.it/geoserver-enterprise/ows\"," +
                    "\"title\":\"GeoServer Enterprise\"," +
                    "\"version\":\"1.1.1\"" +
                "}," +
                "\"mapquest\": {" +
                    "\"ptype\": \"gxp_mapquestsource\"" +
                "}," + 
                "\"osm\": {" + 
                    "\"ptype\": \"gxp_osmsource\"" +
                "}," +
                "\"google\": {" +
                    "\"ptype\": \"gxp_googlesource\"" + 
                "}," +
                "\"bing\": {" +
                    "\"ptype\": \"gxp_bingsource\"" + 
                "}," + 
                "\"ol\": {" + 
                    "\"ptype\": \"gxp_olsource\"" + 
                "}";
            
            if(customSources.length > 0)
                sources += ",";
                
            for(var s=0; s<customSources.length; s++){   
                 var src = Ext.util.JSON.encode(customSources[s]);
                 sources += "\"source" + s + "\":" + src; //JSON.stringify(customSources[s]);
                 
                 if(s + 1 < customSources.length)
                    sources += ",";
            }
             
            sources +="}";

            try{
                sources = Ext.util.JSON.decode(sources);
            }catch(e){
                sources = {
                    mapquest: {
                        ptype: "gxp_mapquestsource"
                    },
                    osm: {
                        ptype: "gxp_osmsource"
                    },
                    google: {
                        ptype: "gxp_googlesource"
                    },
                    bing: {
                        ptype: "gxp_bingsource"
                    },
                    ol: {
                        ptype: "gxp_olsource"
                    }
                };
          
                Ext.Msg.show({
                      title: "Startup",
                      msg: "An error occurred while parsing the CUSTOM GeoServer sources",
                      buttons: Ext.Msg.OK,
                      icon: Ext.MessageBox.ERROR
                });
            }
			      		     
		        /*var auth = 'Basic ' + Base64.encode('admin:admin');
			      Ext.Ajax.defaultHeaders = {
                'Authorization' : auth
            };*/
             
            app = new GeoExplorer.Composer({
                modified: false,
                proxy: proxy,
                xmlJsonTranslateService: "http://demo1.geo-solutions.it/xmlJsonTranslate/",
                defaultSourceType: "gxp_wmssource",
                renderToTab : 'appTabs',
                printService: "http://demo1.geo-solutions.it/geoserver/pdf/",
                mapTitle: GeoExplorer.prototype.viewTabTitle || 'View',
                about: {
                    title: "IDA Map",
                    'abstract': "IDA Map",
                    contact: "<a href='#'>#</a>."
                },
                geocodingData: [
                    ['WESTERN AFRICA', '5.778,3.425,-25.443,24.83'],
                    ['AFRICA', '-17,-35,51,37'],
                    ['GLOBAL', '-170,-80,170,80']
                ],
                sources: sources,
                map: {
					          projection: "EPSG:4326",
                    units: "degrees",
                    maxExtent: [
                        -180, -90, 180, 90
                    ],
                    extent: [
                        -13.86475, 29.72412, 28.58643, 51.16944
                    ],
                    layers: [ {
                        source: "playground",
                        title: "Global Cover",
                        name: "GeoSolutions:GLOBCOVER_2009",
                        group: "background"
                    },{
                        source: "playground",
                        title: "Natural Earth",
                        name: "GeoSolutions:ne_shaded",
                        group: "background"
                    },{
                        source: "ida",
                        title: "Ports",
                        name: "nurc:ports",
                        selected: false,
                        visibility: false,
                        group: "ida"
                    },{
                        source: "ida",
                        title: "Strandings",
                        name: "nurc:strandings",
                        selected: false,
                        visibility: false,
                        group: "ida"
                    },{
                        source: "ida",
                        title: "Chl Spring 2009",
                        name: "nurc:spring2009",
                        selected: false,
                        visibility: false,
                        group: "ida"
                    },{
                        source: "ida",
                        title: "Chl Spring 2008",
                        name: "nurc:spring2008",
                        selected: false,
                        visibility: false,
                        group: "ida"
                    },{
                        source: "ida",
                        title: "Chl Spring 2007",
                        name: "nurc:spring2007",
                        selected: false,
                        visibility: false,
                        group: "ida"
                    },{
                        source: "ida",
                        title: "Distance 1000 m",
                        name: "nurc:eucdist_1000m",
                        selected: false,
                        visibility: false,
                        group: "ida"
                    },{
                        source: "ida",
                        title: "DEM aspect",
                        name: "nurc:aspect",
                        selected: false,
                        visibility: false,
                        group: "ida"
                    },{
                        source: "ida",
                        title: "DEM slope",
                        name: "nurc:slope",
                        selected: false,
                        visibility: false,
                        group: "ida"
                    },{
                        source: "ida",
                        title: "Bathymetry",
                        name: "nurc:gebco_sea",
                        group: "ida"
                    },{
                        source: "ida",
                        title: "Coastlines",
                        name: "nurc:gshs_coastline",
                        selected: false,
                        visibility: false,
                        group: "ida"
                    }]/*,
                    center: [-15,20],
                    zoom: 1*/
                }
            }, mapIdentifier, authorization, fullScreen);   
            
            app.on({
                'portalready' : function(){
                    if(fullScreen){
                        var ovestPanel = Ext.getCmp('tree').findParentByType('panel');
                        ovestPanel.setDisabled();
                        ovestPanel.hide();
                        ovestPanel.collapse();
                    }
                },
                
                'ready' : function(){
                     var graticule = new OpenLayers.Control.Graticule({ 
                          targetSize: 600,
                          displayInLayerSwitcher: false,
                          labelled: true, 
                          visible: true                  
                     });
                     
                     graticule.labelSymbolizer.fontColor = '#45F760';   
                     graticule.lineSymbolizer.strokeColor = "#45F760";  
                     app.mapPanel.map.addControl(graticule); 
                     
                     var mousePositionControl = new OpenLayers.Control.MousePosition();
                     
                     // ////////////////////////////////////////////
                     // Overridding mouse position redraw function
                     // ////////////////////////////////////////////
                     
                     mousePositionControl.formatCoords = function (base) {
                         var t, t2;
                         var degrees = Math.floor(base);
                         var minutes = Math.floor(t = ( base - degrees ) * 60);
                         var seconds = Math.floor(t2 = ( t - minutes ) * 6000);
                         seconds = seconds / 100.00;
                         return ("" +degrees+ "\u00B0 "+minutes +"\u0027 "+seconds+"\u0022");
                     };
                     
                     mousePositionControl.redraw = function(evt) {
                        var lonLat;

                        if (evt == null) {
                            this.reset();
                            return;
                        } else {
                            if (this.lastXy == null ||
                                Math.abs(evt.xy.x - this.lastXy.x) > this.granularity ||
                                Math.abs(evt.xy.y - this.lastXy.y) > this.granularity)
                            {
                                this.lastXy = evt.xy;
                                return;
                            }

                            lonLat = this.map.getLonLatFromPixel(evt.xy);
                            if (!lonLat) { 
                                // map has not yet been properly initialized
                                return;
                            }    
                            if (this.displayProjection) {
                                lonLat.transform(this.map.getProjectionObject(), 
                                                 this.displayProjection );
                            }      
                            this.lastXy = evt.xy;
                        }
                        
                        var newHtml;
                        if (this.map.units == "degrees") {
                            newHtml =  this.formatCoords(lonLat.lon)  + this.separator +
                            this.formatCoords(lonLat.lat);
                        }else{
                           var digits = parseInt(this.numdigits);
                            newHtml =
                                this.prefix +
                                lonLat.lon.toFixed(digits) +
                                this.separator +
                                lonLat.lat.toFixed(digits) +
                                this.suffix;
                        }

                        if (newHtml != this.element.innerHTML) {
                            this.element.innerHTML = newHtml;
                        }
                     };
                     
                     app.mapPanel.map.addControl(mousePositionControl);
                }    
            });
			};			
			
      Ext.Ajax.request({
          //url: "/proxy/?url=" + "http://localhost:8080/geostore/urlConfig.js",
          url: "/urlConfig.js",
          method: 'GET',
          success: function(response, opts){      
              var serverConfig;    
              
              try{
                  serverConfig = Ext.util.JSON.decode(response.responseText);
              }catch(e){
                  Ext.Msg.show({
                        title: "Startup",
                        msg: "An error occurred while parsing the GeoStore URL config: " + response.status,
                        buttons: Ext.Msg.OK,
                        icon: Ext.MessageBox.ERROR
                  });
              }
              
              if(serverConfig){
                  proxy = serverConfig.proxy; 
                  geoStoreBaseURL = serverConfig.geoStoreBase;                  
                  customSources = serverConfig.gsSources;

                  //      
                  // Run the application when browser is ready
                  //
                  Ext.onReady(onReady);
              }
          },
          failure:  function(response, opts){
              Ext.Msg.show({
                    title: "Startup",
                    msg: "An error occurred while getting the GeoStore URL config: " + response.status,
                    buttons: Ext.Msg.OK,
                    icon: Ext.MessageBox.ERROR
              });
          }
      });
        
    </script>
