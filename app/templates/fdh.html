<% extends ./base.html %>
<% subskin extrahead %>
    <!-- OpenLayers resources -->
    <link rel="stylesheet" type="text/css" href="externals/openlayers/theme/default/style.css">
    <script type="text/javascript" src="script/OpenLayers.js"></script>

    <!-- GeoExt resources -->
    <link rel="stylesheet" type="text/css" href="externals/GeoExt/resources/css/popup.css">
    <link rel="stylesheet" type="text/css" href="externals/GeoExt/resources/css/layerlegend.css">
    <link rel="stylesheet" type="text/css" href="externals/GeoExt/resources/css/gxtheme-gray.css">
    <script type="text/javascript" src="script/GeoExt.js"></script> 

    <!-- gxp resources -->
    <link rel="stylesheet" type="text/css" href="externals/gxp/src/theme/all.css">
    <script type="text/javascript" src="script/gxp.js"></script> 

    <!-- proj4js resources 
    <script type="text/javascript" src="script/proj4js.js"></script>-->

    <!-- GeoExplorer resources -->
    <link rel="stylesheet" type="text/css" href="theme/app/geoexplorer.css" />
    <link rel="stylesheet" type="text/css" href="theme/app/fdh.css" />
    <!--[if IE]><link rel="stylesheet" type="text/css" href="theme/app/ie.css"/><![endif]-->        
    <link rel="stylesheet" type="text/css" href="theme/ux/colorpicker/color-picker.ux.css" />
    <script type="text/javascript" src="script/GeoExplorer.js"></script>
    <script type="text/javascript" src="script/ux.js"></script>

    <!-- PrintPreview resources -->
    <link rel="stylesheet" type="text/css" href="externals/PrintPreview/resources/css/printpreview.css">
    <script type="text/javascript" src="script/PrintPreview.js"></script>

    <!-- geocoding data  -->
    <script type="text/javascript" src="data/geocoding.js"></script>
    
    <!-- translation data  -->
    <script type="text/javascript" src="translations/en.js"></script>
    <script type="text/javascript" src="translations/fr.js"></script>
    
    <script>        
        var app, addFDHLayer;
        
        var modified = false;
        
		    var activateSearchTab, activateViewTab, runSimpleSearch;
		    
		    //var proxy = "/proxy/?url=";
		    var proxy = "/FDHWebGis-dev/proxy/?url=";

        Ext.onReady(function(){
            Ext.BLANK_IMAGE_URL = (function() {
                    if (Ext.isIE8 || Ext.isGecko || Ext.isOpera || Ext.isChrome) {
                        return "data:image/gif;base64,R0lGODlhAQABAID/AMDAwAAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==";
                    } else {
                        return "theme/app/img/blank.gif";
                    }
            })();

            OpenLayers.ImgPath = "externals/openlayers/theme/default/img/";
            //Proj4js.defs["EPSG:102113"]="+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +no_defs";
            //Proj4js.defs["EPSG:3003"] = "+proj=tmerc +lat_0=0 +lon_0=9 +k=0.9996 +x_0=1500000 +y_0=0 +ellps=intl +units=m +no_defs";            
            
            gxp.plugins.ZoomToExtent.prototype.closest = false;
            gxp.plugins.FDHGeoCoder.prototype.data = geocoding_data ? geocoding_data : [] ;            
            
            Ext.ux.IFrameComponent = Ext.extend(Ext.BoxComponent, {
                 onRender : function(ct, position){
                      this.el = ct.createChild({
                        tag: 'iframe',
                        id: 'iframe-'+ this.id,
                        frameBorder: 0, 
                        src: this.url
                      });
                 }
            });
            
			// optionally set locale based on query string parameter
            var curLang = OpenLayers.Util.getParameters()["locale"] || GeoExt.Lang.locale || 'en';
			
			var availLanguages = ['en','fr'];
            var gnLangStr = curLang.substr(0,2);
			
			if(availLanguages.indexOf(gnLangStr) < 0){
				gnLangStr = 'en';
			}
			
			var gnURL = 'http://localhost:8080/geonetwork/srv/' + gnLangStr + '/main.home' ;
			
			var portalPanel = new Ext.Panel({
                id: 'portalPanel',
                title: GeoExplorer.prototype.portalTabTitle || 'Portal',
                layout:'fit', 
                items: [ 
                    new Ext.ux.IFrameComponent({ 
                        id: 'fdh-portal',
                        //url: 'http://demo1.geo-solutions.it/geoserver/www/portal/' + gnLangStr + '/index.htm'
                        url: 'http://localhost:8080/geoserver/www/portal/' + gnLangStr + '/index.htm'
                    }) 
                ]
            });
			
            var geonetworkPanel = new Ext.Panel({
                id: 'geonetworkPanel',
                title: GeoExplorer.prototype.searchTabTitle || 'Search',
                layout:'fit', 
                items: [ 
                    new Ext.ux.IFrameComponent({ 
                        id: 'fdh-gn',
                        //url: 'http://demo1.geo-solutions.it/geonetwork/srv/'+gnLangStr+'/main.home' 
                        url: gnURL 
                    }) 
                ]
            });
					
            var appTabs = new Ext.TabPanel({
                items : [portalPanel, geonetworkPanel],
                region: 'center',
                border : false,
                id : 'appTabs',
                deferredRender : false,
                //hideParent: false,
                hideMode : 'visibility'
            });            
            
            var aboutButton = new Ext.Button({
                text: GeoExplorer.prototype.appInfoText,
                iconCls: "icon-geoexplorer",
                handler: function(){
                    var appInfo = new Ext.Panel({
                        header: false,
                        html: "<iframe style='border: none; height: 100%; width: 100%' src='about.html' frameborder='0' border='0'><a target='_blank' href='about.html'>"+ GeoExplorer.prototype.aboutText+"</a> </iframe>"
                    });

                    var win = new Ext.Window({
                        title:  GeoExplorer.prototype.aboutThisMapText,
                        modal: true,
                        layout: "fit",
                        width: 300,
                        height: 300,
                        items: [appInfo]
                    });
                    win.show();
                }
            });
            
            var poweredByGeoSol = new Ext.Button({
                tooltip: 'Powered by GeoSolutions',
                iconCls: "icon-geosol",
                width : 150,
                handler: function(btn){
                    window.open('http://geo-solutions.it/contact/', '_blank');
                }
            });    

            var langData = [['en', 'English'],['fr','Français']];
            
            var query = location.search;        
            if(query && query.substr(0,1) === "?"){
                query = query.substring(1);
            }
            
            var url = Ext.urlDecode(query);        
            var code = url.locale;   

            if(!code){
                code = "en";
            }
            
            var initialLanguageString;
                    
            //check if code is valid
            if(code){
                Ext.each(langData, function(rec){
                    if(rec[0] === code.toLowerCase()){
                        initialLanguageString = rec[1];
                        return;
                    }
                });
            }            
			
			if (GeoExt.Lang) {
                GeoExt.Lang.set(code);
            }
			
            if(!initialLanguageString){
                initialLanguageString = "English";
            }
            
            var languageSelector = new Ext.form.ComboBox({
                store: new Ext.data.ArrayStore({
                    fields: ['code', 'name'],
                    data :  langData
                }),
                displayField: 'name',
                typeAhead: true,
                mode: 'local',
                forceSelection: true,
                triggerAction: 'all',
                emptyText: initialLanguageString,
                selectOnFocus:false,
                editable: false,
                width: 100,
                listeners: {
                    select: function(cb, record, index) {
                        var code = record.get('code');
                        if(code){
                            location.replace(
                                location.pathname+'?locale='+code);
                        }                    
                    }
                }
            });
            
			var headerContent;
			if(gnLangStr === 'fr'){
				headerContent = [
					'<div id="fdh-header">',
					'<div id="left-banner"><img src="theme/app/img/fdh/fdh_left-banner_fr.gif" usemap="#IM_left-banner" width="420" height="86" border="0" /> </div>',
					'<div id="right-banner"><img src="theme/app/img/fdh/fdh_right-banner_fr.gif" usemap="#IM_right-banner" width="378" height="86" border="0" />  </div>',
					'</div>',
					'<map name="IM_left-banner">',
					'<area shape="rect" coords="0,6,72,75" href="http://www.fouta-djallon-programme.org/index.php?lang=fr" alt="Projet De Gestion Integée Des Ressources Naturelles Du Massif Du Fouta Djallon" title="Projet De Gestion Integée Des Ressources Naturelles Du Massif Du Fouta Djallon"    />',
					'</map>',
					'<map name="IM_right-banner">',
					'<area shape="rect" coords="183,3,240,78" href="http://www.unep.org/french/" alt="Programme des Nations Unies pour l’environnement" title="Programme des Nations Unies pour l’environnement"    />',
					'<area shape="rect" coords="246,4,303,79" href="http://www.gefweb.org/" alt="Global Environment Facility" title="Global Environment Facility"    />',
					'<area shape="rect" coords="306,6,373,79" href="http://www.fao.org/index_fr.htm" alt="L\'Organisation des Nations Unies pour l\'alimentation et l\'agriculture" title="L\'Organisation des Nations Unies pour l\'alimentation et l\'agriculture"    />',
					'</map>',
					'</div>'
				].join('');
			} else {
				headerContent = [
					'<div id="fdh-header">',
					'<div id="left-banner"><img src="theme/app/img/fdh/fdh_left-banner_en.gif" usemap="#IM_left-banner" width="420" height="86" border="0" /> </div>',
					'<div id="right-banner"><img src="theme/app/img/fdh/fdh_right-banner_en.gif" usemap="#IM_right-banner" width="378" height="86" border="0" />  </div>',
					'</div>',
					'<map name="IM_left-banner">',
					'<area shape="rect" coords="0,6,72,75" href="http://www.fouta-djallon-programme.org/index.php?lang=en" alt="Fouta Djallon HighLands Integrated Natural Resources Management Project" title="Fouta Djallon HighLands Integrated Natural Resources Management Project"    />',
					'</map>',
					'<map name="IM_right-banner">',
					'<area shape="rect" coords="183,3,240,78" href="http://www.unep.org/" alt="United Nations Environment Programme" title="United Nations Environment Programme"    />',
					'<area shape="rect" coords="246,4,303,79" href="http://www.gefweb.org/" alt="Global Environment Facility" title="Global Environment Facility"    />',
					'<area shape="rect" coords="306,6,373,79" href="http://www.fao.org/" alt="Food and Agriculture Organization of the United Nations" title="Food and Agriculture Organization of the United Nations"    />',
					'</map>',
					'</div>'
				];
			};
			
            var appViewport = new Ext.Viewport({
                id: 'appVieport',
                layout:'fit',
                border:false,
                items: [{
                    region : 'center',
                    layout : 'border',
                    border : false,
                    header : false,                    
                    items : [{
							border: false,
							header: false,
							html:  headerContent,
							region: 'north',
							collapsible: true,
							collapseMode:  'mini',
							hideCollapseTool: true,
							split: true,
							animCollapse : false,
							minHeight: 86,
							maxHeight: 86,
							height: 86,
							id : 'fdhHeader'
						}, appTabs
					],                            
                    bbar : [
						poweredByGeoSol, ' ', aboutButton, '->', languageSelector
					]
                }]
            });
            
			/*
			var mask = Ext.Msg;
				mask.show({
				   msg: "Loading ...",
				   closable: false,
				   mode: true,
				   width: 200,
				   icon: 'download-data'
				});
				
				OpenLayers.Util.onImageLoad = function(){
					 // //////////////////////
					 // OL code
					 // //////////////////////
					 if (!this.viewRequestID ||
						  (this.map && this.viewRequestID == this.map.viewRequestID)) { 
						  this.style.display = "";  
					 }
					  
					 OpenLayers.Element.removeClass(this, "olImageLoadError");
					 
					 // //////////////////////
					 // FDH code
					 // ////////////////////// 
				mask.hide();
				
				appTabs.setActiveTab(0);
			};
			*/
			      
            app = new GeoExplorer.Composer({
                modified: false,
                authStatus: <% status %>,
                proxy: "proxy/?url=",
                printService: "http://demo1.geo-solutions.it/geoserver/pdf/",
                xmlJsonTranslateService: "http://demo1.geo-solutions.it/xmlJsonTranslate/",
                //xmlJsonTranslateService: "http://localhost:8081/web-gis/",
                defaultSourceType: "gxp_wmssource",
                renderToTab : 'appTabs',
                mapTitle : GeoExplorer.prototype.viewTabTitle || 'View',
                about: {
                    title: "Fouta Djallon Higlands programme",
                    'abstract': "Fouta Djallon Higlands comment",
                    contact: "<a href='http://www.fouta-djallon-programme.org/'>http://www.fouta-djallon-programme.org/</a>."
                },
                sources: {
                    fdh: {
                        url: "http://demo1.geo-solutions.it/geoserver/ows",
                        title: "FDH GeoServer",
                        layerBaseParams: { 
                            TILED : true,
                            TILESORIGIN: '-20037508.34,-20037508.34'
                        }
                    },
                    mapquest: {
                        ptype: "gxp_mapquestsource"
                    },
                    osm: {
                        ptype: "gxp_osmsource"
                    },
                    google: {
                        ptype: "gxp_googlesource"
                    },
                    bing: {
                        ptype: "gxp_bingsource"
                    },
                    ol: {
                        ptype: "gxp_olsource"
                    }
                },
                map: {
                    //projection: "EPSG:102113",
					          projection: "EPSG:900913",
                    units: "m",
                    //maxResolution: 19567.87923828125,
                    //resolutions : [19567.87923828125, 9783.939619140625, 4891.9698095703125],
                    //minZoomLevel: 3,
                    //maxZoomLevel: 6,
                    maxExtent: [
                        -20037508.34, -20037508.34,
                        20037508.34, 20037508.34
                    ],
                    layers: [{
                        source: "bing",
                        title: "Bing Aerial",
                        name: "Aerial",
                        group: "background"
                    }, {
                        source: "osm",
                        title: "Open Street Map",
                        name: "mapnik",
                        group: "background"
                    },{
                        source: "mapquest",
                        title: "MapQuest OpenStreetMap",
                        name: "osm",
                        group: "background"
                    },{
                        source: "google",
                        title: "Google Roadmap",
                        name: "ROADMAP",
                        group: "background"
                    },{
                        source: "google",
                        title: "Google Hybrid",
                        name: "HYBRID",
                        group: "background"
                    },{
                        source: "google",
                        title: "Google Terrain",
                        name: "TERRAIN",
                        group: "background"
                    },{
                        source: "fdh",
                        name: "geonetwork:g2006_continents",
                        visibility : false                        
                    },{
                        source: "fdh",
                        name: "geonetwork:g2006_0gen",
                        visibility : false
                    },{
                        source: "fdh",
                        name: "geonetwork:Boundaries"
                    },{
                        source: "fdh",
                        name: "geonetwork:Pilotsitepolygons",
						            uuid : "46c2a724-e416-4054-9a7a-2af4baf3c948"
                    }],
                    center: [-1224514, 1291331],
                    zoom: 6
                }
            });           

			/*
			app.on({
				'portalready' : function(){
					app.portal.on({
						'activate' : function(){
							var map = app.mapPanel.map;
							map.size.w = map.size.w + 1;
							map.updateSize();
							map.size.w = map.size.w - 1;
							map.updateSize();
						}
					});
				}
			});
			*/
			
            addFDHLayer = function(fdhLayerName, fdhLayerUUID){
                var FDHsource = app.layerSources.fdh;
                
                var record = FDHsource.createLayerRecord({
                    name: fdhLayerName,
					          uuid : fdhLayerUUID,
                    source : 'fdh'
                });    
                            
                var layerStore = app.mapPanel.layers;  
                              
                if (record) {
                    layerStore.add([record]);
                }     
                
                modified = true;
                appTabs.setActiveTab(2);
            };
			
			var setActiveTab = function(tabId){        
          appTabs.setActiveTab(tabId);
      };
			
			activateSearchTab = function(){
				setActiveTab(1);
			}
			
			runSimpleSearch = function(keyword, any, raster, vector, interactive, download){
				activateSearchTab();
				
				var searchIframe = document.getElementById('iframe-fdh-gn');				
				searchIframe.src = gnURL + "?keyword=" + keyword + "&any=" + any + "&raster=" + raster + "&vector=" + vector + "&online=" + interactive + "&download=" + download;
				
				/*var gnWindowObj = window.frames[1];
				
				gnWindowObj.Ext.getDom('any').value = keyword;
				
				// FDH - set toolbar any/raster/vector ...   
        gnWindowObj.Ext.getDom('anyradio').checked = any ? true : false;
        gnWindowObj.Ext.getDom('rasterradio').checked = raster ? true : false;
        gnWindowObj.Ext.getDom('vectorradio').checked = vector ? true : false;
        gnWindowObj.Ext.getDom('onlineradio').checked = interactive ? true : false;
        gnWindowObj.Ext.getDom('downloadradio').checked = download ? true : false;
				
				gnWindowObj.runSimpleSearch();*/
			}
			
			viewRecordMetadata = function(uuid){
				if(uuid){
					activateSearchTab();
					var gnWindowObj = window.frames[1];
					gnWindowObj.gn_showSingleMetadataUUID(uuid);
				}
			}
			
			activateViewTab = function(){
				setActiveTab(2);
			}
        });
    </script>